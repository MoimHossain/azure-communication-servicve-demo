package com.acsdemo.acs.sms;

import java.time.Duration;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.env.Environment;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.acsdemo.acs.AzureCredentailHelper;
import com.azure.communication.sms.SmsClient;
import com.azure.communication.sms.SmsClientBuilder;
import com.azure.communication.sms.models.SmsSendResult;


@RestController
@RequestMapping(path = "/sms")
public class SmsController {
     public static final Duration POLLER_WAIT_TIME = Duration.ofSeconds(10);

    @Autowired
    private Environment environment;

	@PostMapping(path= "/", consumes = "application/json", produces = "application/json")
	public SmsResponse sendEmail(@RequestBody SmsPayload smsPayload) throws Exception 
	{
        var responseString = "";
        var acsEndpoint = environment.getProperty("ACS_SMS_ENDPOINT");

        try {
            var azureCredentailHelper = new AzureCredentailHelper(environment);
            var credential = azureCredentailHelper.getCredential();

            SmsClient smsClient = new SmsClientBuilder()
                .endpoint(acsEndpoint)
                .credential(credential)
                .buildClient();
            
            SmsSendResult sendResult = smsClient.send(
                smsPayload.from(),
                smsPayload.to(),
                smsPayload.content());

            System.out.println("Message Id: " + sendResult.getMessageId());
            System.out.println("Recipient Number: " + sendResult.getTo());
            System.out.println("Send Result Successful:" + sendResult.isSuccessful());
            responseString = "Successfully sent";
        } 
        catch (Exception e) {
            responseString = e.getMessage();
            System.out.println(e.getMessage());
        }
        return new SmsResponse(responseString);
	}
}
