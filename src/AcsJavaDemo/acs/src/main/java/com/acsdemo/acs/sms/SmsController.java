package com.acsdemo.acs.sms;

import java.time.Duration;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.env.Environment;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.azure.core.util.Context;
import com.azure.communication.sms.SmsClient;
import com.azure.communication.sms.SmsClientBuilder;
import com.azure.communication.sms.models.SmsSendOptions;
import com.azure.communication.sms.models.SmsSendResult;


@RestController
@RequestMapping(path = "/sms")
public class SmsController {
     public static final Duration POLLER_WAIT_TIME = Duration.ofSeconds(10);

    @Autowired
    private Environment environment;

	@PostMapping(path= "/", consumes = "application/json", produces = "application/json")
	public SmsResponse sendEmail(@RequestBody SmsPayload smsPayload) throws Exception 
	{
        var responseString = "";
        var connectionString = environment.getProperty("AZ_COMM_SMS_CONN_STR");

        try {
            SmsClient smsClient = new SmsClientBuilder()
                .connectionString(connectionString)
                .buildClient();
            
                /*
            SmsSendOptions options = new SmsSendOptions();
            options.setDeliveryReportEnabled(true);
            options.setTag(smsPayload.tag());

            System.out.println("From: " + smsPayload.from());
            System.out.println(smsPayload.to());

            Iterable<SmsSendResult> sendResults = smsClient.sendWithResponse(
                smsPayload.from(),
                smsPayload.to(),
                smsPayload.content(),
                options,
                Context.NONE).getValue();

            for (SmsSendResult result : sendResults) {
                System.out.println("Message Id: " + result.getMessageId());
                System.out.println("Recipient Number: " + result.getTo());
                System.out.println("Send Result Successful:" + result.isSuccessful());
            }*/
            SmsSendResult sendResult = smsClient.send(
                smsPayload.from(),
                smsPayload.to(),
                smsPayload.content());

            System.out.println("Message Id: " + sendResult.getMessageId());
            System.out.println("Recipient Number: " + sendResult.getTo());
            System.out.println("Send Result Successful:" + sendResult.isSuccessful());
            responseString = "Successfully sent";
        } 
        catch (Exception e) {
            responseString = e.getMessage();
            System.out.println(e.getMessage());
        }
        return new SmsResponse(responseString);
	}
}
