

resource "azurerm_resource_group" "rg" {
  location = var.resource_group_location
  name     = var.resource_group_name
}

resource "azapi_resource" "emailservice" {
  type = "Microsoft.Communication/emailServices@2023-03-31"
  name = var.acseName
  location = var.acsLocation 
  parent_id = azurerm_resource_group.rg.id
  tags = {
    PURPOSE = "DEMO"
    COSTCENTER = "MOIMHA"
  }
  body = jsonencode({
    properties = {
      dataLocation = var.acsDataLocation
    }
  })
}

resource "azapi_resource" "emailDomain" {
  type = "Microsoft.Communication/emailServices/domains@2023-03-31"
  name = "AzureManagedDomain"
  location = var.acsLocation 
  parent_id = azapi_resource.emailservice.id
  tags = {
    PURPOSE = "DEMO"
    COSTCENTER = "MOIMHA"
  }
  body = jsonencode({
    properties = {
      domainManagement = "AzureManaged"
      userEngagementTracking = "Enabled"
    }
  })
  depends_on = [
    azapi_resource.emailservice
  ]
}

resource "azapi_resource" "communicationService" {
  type = "Microsoft.Communication/communicationServices@2023-03-31"
  name = "${var.acseName}-cs"
  location = var.acsLocation 
  parent_id = azurerm_resource_group.rg.id
  tags = {
    PURPOSE = "DEMO"
    COSTCENTER = "MOIMHA"
  }
  body = jsonencode({
    properties = {
      dataLocation = var.acsDataLocation
      linkedDomains = [
          azapi_resource.emailDomain.id
      ]
    }
  })
  depends_on = [
    azapi_resource.emailDomain
  ]
}

